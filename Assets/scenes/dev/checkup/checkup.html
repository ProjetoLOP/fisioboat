<!DOCTYPE html>
<html lang="pt_BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developing</title>

    <!-- MoveNet Lib -->
    <script id="tfjs" src="/Assets/scripts/Libs/tfjs.js"></script>
    <script id="pose-detection" src="/Assets/scripts/Libs/pose-detection.js"></script>
    <script id="tfjs-backend-webgl" src="/Assets/scripts/Libs/tfjs-backend-webgl.js"></script>

    <!-- Aframe Lib -->
    <script src="/Assets/scripts/Libs/aframe.min.js"></script>
    <script src="/Assets/scripts/Libs/aframe-extras.min.js"></script>
    <script src="/Assets/scripts/Libs/combo-ocean.js"></script>
    <script src="/Assets/scripts/Libs/RGBELoader.js"></script>
    <script>
        // Register the 'hdri' component
        AFRAME.registerComponent('hdri', {
            schema: {
                url: { type: 'string' }, // Define the data schema
            },
            init: function () {
                const { url } = this.data; // Get the URL from the component data
                const sceneEl = this.el; // Reference to the A-Frame scene element
                const scene = sceneEl.object3D; // THREE.js scene object
                const renderer = sceneEl.renderer; // A-Frame renderer
                // Set up the HDRI loader
                const rgbeLoader = new THREE.RGBELoader();
                rgbeLoader.setDataType(THREE.UnsignedByteType);
                rgbeLoader.load(url, (texture) => {
                    // PMREM Generator for converting the texture to a suitable format
                    const pmremGenerator = new THREE.PMREMGenerator(renderer);
                    pmremGenerator.compileEquirectangularShader();
                    const envMap = pmremGenerator.fromEquirectangular(texture).texture;
                    scene.environment = envMap; // Set the scene environment
                    texture.dispose();
                    pmremGenerator.dispose();
                });
            }
        });
    </script>
    <script src="/Assets/scenes/dev/baseScene/baseScene.js"></script>

    <link rel="stylesheet" href="/Assets/scenes/dev/checkup/style.css">
</head>

<body>
    <div class="active" id="checkupOverlay">
        <div id="video-container">
            <video id="video"></video>
            <div class="loading-dots active">
                <span>.</span><span>.</span><span>.</span>
            </div>
        </div>
        <h1>Aperte <i>"Enter"</i> quando estiver pronto</h1>
    </div>

    <a-scene renderer="colorManagement: true; physicallyCorrectLights: true;"
        hdri="url: /Assets/scenario/hdr/afternoon.hdr">
        <a-sky rotation="0 180 0" src="/Assets/scenario/textures/afternoon-sky.jpeg"></a-sky>

        <a-ocean-plane id="ocean" position="0 -1 0"></a-ocean-plane>

        <!-- Barcos -->
        <a-entity id="boat" gltf-model="/Assets/scenario/models/BarcoTexturizado.glb" rotation="0 0 0"
            position="0 0.6 0" boat-controls float-on-ocean="oceanId: ocean"></a-entity>

        <!-- Telespectador -->
        <a-entity camera look-controls follow="target: #boat; offset: 0 1.5 -1"></a-entity>
    </a-scene>

    <!-- MoveNet Manipulation -->
    <!-- <script src="/Assets/scripts/moveNet.js"></script> -->
    <script src="/Assets/scripts/moveNet.min.js"></script>
    <script>
        // Função para acessar a câmera
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: false
                });

                const videoContainer = document.getElementById("video-container");
                const loadingDots = videoContainer.querySelector(".loading-dots");
                const videoElement = videoContainer.querySelector('#video');

                videoElement.srcObject = stream;
                videoElement.play();

                loadingDots.classList.remove("active");

                console.log('Câmera inicializada com sucesso');
            } catch (error) {
                console.error('Erro ao acessar a câmera:', error);
                alert('Não foi possível acessar sua câmera. Por favor, verifique as permissões.');
            }
        }

        // Função para preparar vídeo
        function setupVideo() {
            const videoEl = document.getElementById("video");

            videoEl.src = "/Assets/videos/stress4.mp4";
            videoEl.loop = true;
            videoEl.play();

            videoEl.addEventListener("playing", () => {
                const loadingDots = document.querySelector(".loading-dots");
                loadingDots.classList.remove("active");
            });
        }

        // Inicializa a câmera/video quando a página carrega
        // document.addEventListener('click', () => {
        //     setupVideo();
        // }, { once: true });

        // Função para iniciar o jogo quando Enter for pressionado
        document.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                detectPose();

                const loadingDots = document.querySelector(".loading-dots");
                loadingDots.classList.add("active");
            }
        });

        window.addEventListener("detector:ready", () => {
            // setupVideo();
            setupCamera();
        });

        window.addEventListener("pose:ready", () => {
            setTimeout(startGame, 1200)
        });

        // Função para iniciar o jogo
        function startGame() {
            const overlay = document.getElementById('checkupOverlay');
            const videoContainer = document.getElementById('video-container');
            overlay.classList.remove('active');
            videoContainer.classList.add('game-started');
            // Aqui você pode adicionar o código para iniciar seu jogo
            console.log('Iniciando o jogo...');
            // alert('Jogo iniciado!');
        }
    </script>
</body>

</html>